name: macOS GUI Remote (6 Horas)

on: 
  workflow_dispatch:

jobs:
  gui-session:
    runs-on: macos-latest
    # Aumentamos el tiempo de espera al m√°ximo permitido por GitHub (6 horas)
    timeout-minutes: 360 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Conectar a Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: latest
          args: --ssh --hostname=github-mac-gui

      - name: Activar Escritorio Remoto (VNC)
        run: |
          echo "üñ•Ô∏è Configurando VNC..."
          # Contrase√±a para entrar al entorno gr√°fico. 
          # PUEDES CAMBIAR "Secreto123!" POR LO QUE QUIERAS.
          VNC_PASSWORD="Secreto123!"
          
          # Comandos de Apple para forzar el encendido del servidor VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
          
          echo "‚úÖ VNC Activado."

      - name: Informaci√≥n de Conexi√≥n
        run: |
          echo "-------------------------------------------------------"
          echo "üì° IP DE TAILSCALE:"
          TS_IP=$(/Applications/Tailscale.app/Contents/MacOS/Tailscale ip -4)
          echo "$TS_IP"
          echo "-------------------------------------------------------"
          echo "üëÄ C√ìMO VER EL ESCRITORIO:"
          echo "1. Abre tu visor VNC favorito (RealVNC, Remmina, o Screen Sharing en Mac)."
          echo "2. Con√©ctate a: $TS_IP"
          echo "   (O usa el hostname: github-mac-gui)"
          echo "3. La contrase√±a es: Secreto123!"
          echo "-------------------------------------------------------"
          echo "‚è≥ Manteniendo sesi√≥n viva por 6 horas..."
          
          # Esperar 6 horas (21600 segundos)
          sleep 21600
