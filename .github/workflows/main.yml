name: macOS GUI Auto-Path (SoluciÃ³n Final)
on: workflow_dispatch

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 

    steps:
      - name: Instalar Herramientas Base
        run: |
          brew install cloudflare/cloudflare/cloudflared
          brew install tiger-vnc
          echo "âœ… InstalaciÃ³n completada."

      - name: Detectar Rutas e Iniciar VNC
        run: |
          # 1. Crear carpeta de configuraciÃ³n
          mkdir -p ~/.vnc
          
          # 2. Buscar dinÃ¡micamente dÃ³nde se instalÃ³ TigerVNC
          # Esto evita el error de "No such file or directory"
          VNC_BIN_DIR=$(find /opt/homebrew/bin /usr/local/bin -name vncpasswd -executable -print -quit | xargs dirname)
          echo "Ruta de ejecutables encontrada: $VNC_BIN_DIR"
          
          # 3. Configurar contraseÃ±a (123456)
          echo "123456" | $VNC_BIN_DIR/vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # 4. Lanzar el servidor en el puerto 5901 (:1)
          $VNC_BIN_DIR/vncserver :1 -geometry 1280x720 -depth 24 -localhost no
          echo "âœ… Servidor TigerVNC activo en puerto 5901."

      - name: Iniciar TÃºnel Cloudflare
        run: |
          # Crear tÃºnel hacia el puerto del servidor TigerVNC (5901)
          cloudflared tunnel --url tcp://localhost:5901 > tunnel.log 2>&1 &
          
          sleep 20
          echo "-------------------------------------------------------"
          echo "ðŸ”— URL PARA TU CMD DE WINDOWS:"
          URL=$(grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log | sed 's/https:\/\///')
          echo "$URL"
          echo "-------------------------------------------------------"
          echo "ðŸš€ INSTRUCCIONES EN TU PC:"
          echo "1. Abre CMD y pega: .\cloudflared-windows-amd64.exe access tcp --hostname $URL --listener localhost:5901"
          echo "2. En TigerVNC Viewer conecta a: localhost:5901"
          echo "3. Password: 123456"
          echo "-------------------------------------------------------"
          
          # Mantener el job activo por 6 horas
          sleep 21600
