name: macOS GUI via Browser (SoluciÃ³n Final)
on: workflow_dispatch

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 

    steps:
      - name: Instalar Cloudflared
        run: |
          brew install cloudflare/cloudflare/cloudflared
          echo "âœ… Cloudflared instalado."

      - name: Configurar VNC y Forzar GrÃ¡ficos
        run: |
          # 1. Configurar VNC de Apple
          VNC_PASSWORD="Secreto123!"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
          
          # 2. Forzar resoluciÃ³n y despertar sistema
          sudo /usr/bin/defaults write /Library/Preferences/com.apple.windowserver.plist DisplayResolutionEnabled -bool true
          # Abrir utilidades bÃ¡sicas para forzar renderizado
          open -a Finder
          open -a Calculator

      - name: Instalar y Lanzar noVNC Manualmente
        run: |
          # Descargar noVNC directamente desde GitHub
          curl -L https://github.com/novnc/noVNC/archive/refs/tags/v1.5.0.tar.gz -o novnc.tar.gz
          tar -xzf novnc.tar.gz
          cd noVNC-1.5.0
          
          # Descargar websockify (el puente necesario)
          curl -L https://github.com/novnc/websockify/archive/refs/tags/v0.12.0.tar.gz -o websockify.tar.gz
          tar -xzf websockify.tar.gz
          mv websockify-0.12.0 utils/websockify
          
          # Lanzar el proxy en el puerto 8080 apuntando al VNC local (5900)
          ./utils/novnc_proxy --vnc localhost:5900 --listen localhost:8080 &
          echo "âœ… Proxy noVNC iniciado."

      - name: Iniciar TÃºnel y Mostrar Link
        run: |
          # Crear tÃºnel hacia el puerto web 8080
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          
          sleep 20
          echo "-------------------------------------------------------"
          echo "ðŸ”— LINK PARA EL NAVEGADOR (CHROME/EDGE):"
          URL=$(grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log)
          echo "$URL/vnc.html?autoconnect=true"
          echo "-------------------------------------------------------"
          echo "ðŸ”‘ CONTRASEÃ‘A VNC: Secreto123!"
          echo "-------------------------------------------------------"
          
          # Mantener vivo 6 horas
          sleep 21600
