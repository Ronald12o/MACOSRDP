name: macOS GUI via Browser (noVNC)
on: workflow_dispatch

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 

    steps:
      - name: Instalar Dependencias
        run: |
          brew install cloudflare/cloudflare/cloudflared
          # Instalar noVNC para ver la pantalla en el navegador
          brew install novnc
          echo "‚úÖ Dependencias instaladas."

      - name: Configurar VNC y Forzar Salida de Video
        run: |
          # 1. Configurar VNC de Apple
          VNC_PASSWORD="Secreto123!"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
          
          # 2. Truco para "despertar" el monitor virtual
          # Abrimos varias apps y forzamos resoluci√≥n
          sudo /usr/bin/defaults write /Library/Preferences/com.apple.windowserver.plist DisplayResolutionEnabled -bool true
          open -a Finder
          open -a System\ Settings

      - name: Iniciar Proxy Web (noVNC) y T√∫nel
        run: |
          # 1. Iniciar noVNC en el puerto 8080 (convierte VNC a Web)
          # Usamos la ruta de brew para websockify
          $(brew --prefix novnc)/bin/novnc_proxy --vnc localhost:5900 --listen localhost:8080 &
          
          # 2. Crear t√∫nel de Cloudflare hacia el puerto WEB (8080)
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          
          sleep 15
          echo "-------------------------------------------------------"
          echo "üîó LINK PARA VER LA MAC EN TU NAVEGADOR:"
          URL=$(grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log)
          echo "$URL/vnc.html?autoconnect=true&password=Secreto123!"
          echo "-------------------------------------------------------"
          echo "‚ö†Ô∏è IMPORTANTE: Si te pide contrase√±a en la web, es: Secreto123!"
          echo "-------------------------------------------------------"
          
          # Mantener vivo 6 horas
          sleep 21600
