name: macOS GUI Cloudflare (6 Horas) - EL DEFINITIVO

on: 
  workflow_dispatch:

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 

    steps:
      - name: Instalar Cloudflared y Configurar VNC
        run: |
          # 1. Instalar Cloudflared
          brew install cloudflare/cloudflare/cloudflared
          
          # 2. Configurar VNC
          VNC_PASSWORD="Secreto123!"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all

          # 3. Iniciar T√∫nel de Cloudflare
          # Esto genera una URL p√∫blica temporal para el puerto 5900
          echo "üöÄ Iniciando t√∫nel..."
          cloudflared tunnel --url tcp://localhost:5900 > tunnel.log 2>&1 &
          
          sleep 10 # Esperar a que genere el link

      - name: Obtener Link de Conexi√≥n
        run: |
          echo "-------------------------------------------------------"
          echo "üîó TU URL DE CONEXI√ìN ES:"
          grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log | sed 's/https:\/\///' || echo "Reintentando..."
          echo "-------------------------------------------------------"
          echo "üëÄ PASOS PARA WINDOWS:"
          echo "1. Descarga cloudflared en tu PC (google: cloudflared windows download)"
          echo "2. En tu CMD de Windows escribe:"
          echo "   cloudflared access tcp --hostname TU_URL_AQU√ç --listener localhost:5900"
          echo "3. Abre VNC Viewer en localhost:5900"
          echo "-------------------------------------------------------"
          sleep 21600
