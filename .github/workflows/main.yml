name: macOS GUI Final Emergency
on: workflow_dispatch

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 

    steps:
      - name: InstalaciÃ³n Forzada
        run: |
          brew install cloudflare/cloudflare/cloudflared tiger-vnc
          
      - name: EjecuciÃ³n por Fuerza Bruta
        run: |
          # 1. Definir la ruta que tu log confirmÃ³
          VNC_DIR="/opt/homebrew/Cellar/tiger-vnc/1.15.0/bin"
          
          # 2. Listar archivos para confirmar (verÃ¡s esto en el log)
          echo "Contenido de la carpeta bin:"
          ls -l $VNC_DIR
          
          # 3. Forzar permisos de ejecuciÃ³n
          sudo chmod +x $VNC_DIR/vncpasswd
          sudo chmod +x $VNC_DIR/vncserver
          
          # 4. Configurar VNC
          mkdir -p ~/.vnc
          echo "123456" | $VNC_DIR/vncpasswd -f > ~/.vnc/passwd
          sudo chmod 600 ~/.vnc/passwd
          
          # 5. Lanzar el servidor
          $VNC_DIR/vncserver :1 -geometry 1280x720 -depth 24 -localhost no
          echo "âœ… Servidor iniciado."

      - name: Iniciar TÃºnel
        run: |
          # Usamos la ruta de cloudflared que tambiÃ©n vimos en tu log
          CF_BIN="/opt/homebrew/Cellar/cloudflared/2025.11.1/bin/cloudflared"
          $CF_BIN tunnel --url tcp://localhost:5901 > tunnel.log 2>&1 &
          
          sleep 20
          echo "-------------------------------------------------------"
          echo "ðŸ”— URL PARA TU CMD DE WINDOWS:"
          URL=$(grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log | sed 's/https:\/\///')
          echo "$URL"
          echo "-------------------------------------------------------"
          echo "ðŸš€ Password: 123456 | Puerto: 5901"
          echo "-------------------------------------------------------"
          sleep 21600
