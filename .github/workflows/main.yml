name: macOS GUI Final (Cloudflare)

on: 
  workflow_dispatch:

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 

    steps:
      - name: Instalar Herramientas
        run: |
          brew install cloudflare/cloudflare/cloudflared
          echo "‚úÖ Cloudflared instalado."

      - name: Configurar VNC y Forzar Gr√°ficos
        run: |
          # 1. Configurar contrase√±a y activar VNC
          VNC_PASSWORD="Secreto123!"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
          
          # 2. Forzar al sistema a no dormir y despertar el WindowServer
          sudo systemsetup -setdisplaysleep Off > /dev/null 2>&1
          
          # 3. Lanzar aplicaciones en el espacio de usuario para generar imagen
          # Esto "obliga" a macOS a dibujar algo en la pantalla virtual
          gui_user_id=$(id -u)
          sudo launchctl asuser $gui_user_id open -a Finder
          sudo launchctl asuser $gui_user_id open -a System\ Settings
          
          echo "‚úÖ VNC y Entorno Gr√°fico listos."

      - name: Iniciar T√∫nel y Mantener Vivo
        run: |
          # Iniciar t√∫nel en segundo plano
          cloudflared tunnel --url tcp://localhost:5900 > tunnel.log 2>&1 &
          
          echo "‚è≥ Esperando 15 segundos para estabilidad..."
          sleep 15
          
          echo "-------------------------------------------------------"
          echo "üîó TU URL DE CONEXI√ìN ES:"
          # Extraer la URL de Cloudflare del log
          grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log | sed 's/https:\/\///'
          echo "-------------------------------------------------------"
          echo "üëÄ PASOS PARA CONECTAR DESDE WINDOWS:"
          echo "1. Abre tu CMD en Windows."
          echo "2. Ejecuta: .\cloudflared-windows-amd64.exe access tcp --hostname TU_URL_AQU√ç --listener localhost:5900"
          echo "3. Abre TigerVNC y con√©ctate a: localhost:5900"
          echo "4. Password: Secreto123!"
          echo "-------------------------------------------------------"
          
          # Mantener el workflow vivo por 6 horas
          sleep 21600
