name: macOS GUI Remote (6 Horas) - ULTIMATE

on: 
  workflow_dispatch:

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Conectar a Tailscale
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: latest
          args: --ssh --hostname=github-mac-gui

      - name: Activar Escritorio Remoto (VNC)
        run: |
          echo "üñ•Ô∏è Configurando VNC..."
          VNC_PASSWORD="Secreto123!"
          
          # Configuraci√≥n de Apple Remote Desktop
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
          -restart -agent -privs -all
          
          echo "‚úÖ VNC Activado."

      - name: Obtener IP y Mantener Vivo
        run: |
          echo "‚è≥ Esperando a que el t√∫nel Tailscale se estabilice..."
          sleep 10
          
          # Intentar obtener la IP con reintentos
          for i in {1..5}; do
            TS_IP=$(tailscale ip -4) && break || sleep 5
          done

          if [ -z "$TS_IP" ]; then
            echo "‚ùå No se pudo obtener la IP de Tailscale. Revisa el Auth Key."
            exit 1
          fi

          echo "-------------------------------------------------------"
          echo "üì° CONEXI√ìN EXITOSA"
          echo "IP DE TAILSCALE: $TS_IP"
          echo "HOSTNAME: github-mac-gui"
          echo "-------------------------------------------------------"
          echo "üëÄ PASOS PARA CONECTAR:"
          echo "1. Aseg√∫rate de que TU PC tenga Tailscale activo."
          echo "2. Usa un cliente VNC y con√©ctate a: $TS_IP"
          echo "3. Password: Secreto123!"
          echo "-------------------------------------------------------"
          
          # Mantener la sesi√≥n viva
          echo "‚è≥ El runner estar√° activo por 6 horas. No cierres este log."
          sleep 21600
