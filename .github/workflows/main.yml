name: macOS RDP Real
on: workflow_dispatch

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 

    steps:
      - name: Instalar Cloudflared
        run: brew install cloudflare/cloudflare/cloudflared

      - name: Configurar Escritorio Nativo
        run: |
          # 1. Configurar contraseÃ±a del VNC de Apple
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvnpw -vncpw "123456" \
          -restart -agent -privs -all
          
          # 2. EL TRUCO PARA LA PANTALLA NEGRA: 
          # Forzamos al sistema a creer que hay un monitor conectado y despierto
          sudo defaults write /Library/Preferences/com.apple.windowserver.plist DisplayResolutionEnabled -bool true
          nohup osascript -e 'tell application "System Events" to repeat
            key code 123
            delay 60
          end repeat' > /dev/null 2>&1 &

      - name: Iniciar TÃºnel
        run: |
          # El VNC de Apple corre en el puerto 5900
          cloudflared tunnel --url tcp://localhost:5900 > tunnel.log 2>&1 &
          sleep 10
          echo "-------------------------------------------------------"
          echo "ðŸ”— URL PARA TU CMD DE WINDOWS:"
          URL=$(grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log | sed 's/https:\/\///')
          echo "$URL"
          echo "-------------------------------------------------------"
          echo "ðŸš€ PASOS EN TU PC:"
          echo "1. Abre CMD y pega: .\cloudflared-windows-amd64.exe access tcp --hostname $URL --listener localhost:5900"
          echo "2. Abre TigerVNC y conecta a: localhost:5900"
          echo "3. Password: 123456"
          echo "-------------------------------------------------------"
          sleep 21600
