name: macOS VNC Fix Security
on: workflow_dispatch

jobs:
  gui-session:
    runs-on: macos-latest
    timeout-minutes: 360 

    steps:
      - name: Instalar Cloudflared
        run: brew install cloudflare/cloudflare/cloudflared

      - name: Configurar Acceso Total
        run: |
          # 1. Configurar VNC con contraseÃ±a 123456
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw "123456" \
          -restart -agent -privs -all

          # 2. Comando SECRETO para arreglar el error de seguridad
          # Esto permite conexiones VNC estÃ¡ndar sin encriptaciÃ³n Apple
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool true
          sudo defaults write /Library/Preferences/com.apple.vnclatency.plist "VNCPassword" -string "123456"

      - name: Iniciar TÃºnel
        run: |
          cloudflared tunnel --url tcp://localhost:5900 > tunnel.log 2>&1 &
          sleep 10
          echo "-------------------------------------------------------"
          echo "ðŸ”— URL NUEVA:"
          URL=$(grep -oE "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" tunnel.log | sed 's/https:\/\///')
          echo "$URL"
          echo "-------------------------------------------------------"
          echo "ðŸš€ EN TIGERVNC:"
          echo "Server: localhost:5900"
          echo "Password: 123456"
          echo "-------------------------------------------------------"
          sleep 21600
